{"ast":null,"code":"function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport { v4 as uuidv4 } from \"uuid\";\nimport * as firebase from \"firebase/app\";\nimport \"firebase/database\";\nconst config = {\n  apiKey: \"AIzaSyDp01-0TwxRjNC05CuDcpauXRyLSMv0RRw\",\n  authDomain: \"darts-yeslab.firebaseapp.com\",\n  databaseURL: \"https://darts-yeslab.firebaseio.com\",\n  projectId: \"darts-yeslab\",\n  storageBucket: \"darts-yeslab.appspot.com\",\n  messagingSenderId: \"426404952698\",\n  appId: \"1:426404952698:web:738ac9ab1342a1177419c3\",\n  measurementId: \"G-7DHLMBZXEN\"\n};\n\nif (!firebase.apps.length) {\n  firebase.initializeApp(config);\n}\n\nconst database = firebase.database();\n\nfunction db(ref) {\n  return database.ref(`/v1/${ref}`);\n}\n\nfunction createUser(userID) {\n  const user = {\n    created_at: Date.now()\n  };\n  return new Promise((resolve, reject) => {\n    console.log(\"??\");\n    db(\"users/\" + userID).set(user, error => {\n      if (error) {\n        reject(error);\n      }\n\n      resolve(_objectSpread({}, user, {\n        id: userID\n      }));\n    });\n  });\n}\n\nexport function getUser(userID) {\n  return db(`users/${userID}`).once(\"value\").then(function (snapshot) {\n    const user = snapshot.val();\n\n    if (user) {\n      return _objectSpread({}, user, {\n        id: userID\n      });\n    }\n\n    return createUser(userID);\n  });\n}\nexport function getGame(gameID, userID, onUpdate) {\n  return new Promise((resolve, reject) => {\n    db(`/games/${gameID}`).on(\"value\", snapshot => {\n      const game = snapshot.val();\n      onUpdate(game);\n    });\n  });\n}\nexport function getGameId(join_id) {\n  return new Promise((resolve, reject) => {\n    db(\"games\").orderByChild(\"join_id\").equalTo(join_id).on(\"value\", function (snapshot) {\n      snapshot.forEach(function (data) {\n        const id = data.key;\n\n        if (!id) {\n          reject(\"Game not found.\");\n        } else {\n          resolve(id);\n        }\n      });\n    });\n  });\n}\nexport function createGame(userID, name) {\n  const gameID = uuidv4();\n  const game = {\n    creator_id: userID,\n    join_id: gameID.slice(0, 4),\n    players: [{\n      id: userID,\n      name\n    }]\n  };\n  return new Promise((resolve, reject) => {\n    db(`games/${gameID}`).set(game, error => {\n      if (error) {\n        reject(error);\n      } else {\n        resolve(_objectSpread({}, game, {\n          id: gameID\n        }));\n      }\n    });\n  });\n}\nexport function addPlayerToGame(gameID, userID, name) {\n  return new Promise((resolve, reject) => {\n    db(`games/${gameID}`).once(\"value\").then(snapshot => {\n      const game = snapshot.val();\n\n      if (!game.players.some(player => player.id === userID)) {\n        const newGame = _objectSpread({}, game, {\n          players: game.players.concat({\n            id: userID,\n            name,\n            score: DEFAULT_SCORE\n          })\n        });\n\n        db(\"games/\" + gameID).update(newGame, error => {\n          if (error) {\n            console.error(\"error\", error);\n          }\n        });\n      }\n    });\n  });\n}\nexport function updateScore(gameID, userID, number) {\n  return new Promise((resolve, reject) => {\n    db(`games/${gameID}`).once(\"value\").then(snapshot => {\n      const game = snapshot.val();\n\n      const newGame = _objectSpread({}, game);\n\n      newGame.players = newGame.players.length > 2 ? handleThreePlayerGame(userID, newGame.players, number) : handleTwoPlayerGame(userID, newGame.players, number);\n      db(\"games/\" + gameID).set(newGame, error => {\n        if (error) {\n          console.error(\"error\", error);\n        }\n      });\n    });\n  });\n}\nexport function resetScore(gameID, userID) {\n  return new Promise((resolve, reject) => {\n    db(`games/${gameID}`).once(\"value\").then(snapshot => {\n      const game = snapshot.val();\n\n      const newGame = _objectSpread({}, game);\n\n      newGame.players = newGame.players.map(player => {\n        if (player.id !== userID) {\n          return player;\n        }\n\n        return _objectSpread({}, player, {\n          score: DEFAULT_SCORE\n        });\n      });\n      db(\"games/\" + gameID).set(newGame, error => {\n        if (error) {\n          console.error(\"error\", error);\n        }\n      });\n    });\n  });\n}\nexport function newGame(gameID) {\n  return new Promise((resolve, reject) => {\n    db(\"games/\" + gameID).once(\"value\").then(snapshot => {\n      const game = snapshot.val();\n\n      const newGame = _objectSpread({}, game);\n\n      newGame.players = newGame.players.map(player => {\n        return _objectSpread({}, player, {\n          score: DEFAULT_SCORE\n        });\n      });\n      db(\"games/\" + gameID).set(newGame, error => {\n        if (error) {\n          console.error(\"error\", error);\n        }\n      });\n    });\n  });\n}\n\nfunction handleTwoPlayerGame(userID, originalPlayers, number) {\n  let newPlayers = originalPlayers.slice();\n  newPlayers = newPlayers.map(player => {\n    if (player.id !== userID) {\n      return player;\n    }\n\n    const newPlayer = _objectSpread({}, player);\n\n    const scoreForNumber = newPlayer.score[number];\n\n    if (scoreForNumber === 3) {\n      // Update other scores\n      newPlayer.score.total += typeof number === \"string\" ? 25 : number;\n    } else {\n      newPlayer.score[number] = scoreForNumber + 1;\n    }\n\n    return _objectSpread({}, newPlayer);\n  });\n  return newPlayers;\n}\n\nfunction handleThreePlayerGame(userID, originalPlayers, number) {\n  let newPlayers = originalPlayers.slice();\n  const amAddingToOtherPlayers = newPlayers.some(player => {\n    if (player.id === userID && player.score[number] === 3) {\n      return true;\n    }\n  });\n\n  if (amAddingToOtherPlayers) {\n    newPlayers = newPlayers.map(player => {\n      const newPlayer = _objectSpread({}, player);\n\n      if (newPlayer.score[number] !== 3 && newPlayer.id !== userID) {\n        newPlayer.score.total += typeof number === \"string\" ? 25 : number;\n      }\n\n      return _objectSpread({}, newPlayer);\n    });\n  } else {\n    newPlayers = newPlayers.map(player => {\n      if (player.id !== userID) {\n        return player;\n      }\n\n      const newPlayer = _objectSpread({}, player);\n\n      const scoreForNumber = newPlayer.score[number];\n      newPlayer.score[number] = scoreForNumber + 1;\n      return _objectSpread({}, newPlayer);\n    });\n  }\n\n  return newPlayers;\n}","map":{"version":3,"sources":["/Users/sean/Workspace/darts/api/firebase.ts"],"names":["v4","uuidv4","firebase","config","apiKey","authDomain","databaseURL","projectId","storageBucket","messagingSenderId","appId","measurementId","apps","length","initializeApp","database","db","ref","createUser","userID","user","created_at","Date","now","Promise","resolve","reject","console","log","set","error","id","getUser","once","then","snapshot","val","getGame","gameID","onUpdate","on","game","getGameId","join_id","orderByChild","equalTo","forEach","data","key","createGame","name","creator_id","slice","players","addPlayerToGame","some","player","newGame","concat","score","DEFAULT_SCORE","update","updateScore","number","handleThreePlayerGame","handleTwoPlayerGame","resetScore","map","originalPlayers","newPlayers","newPlayer","scoreForNumber","total","amAddingToOtherPlayers"],"mappings":"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","sourcesContent":["import { v4 as uuidv4 } from \"uuid\";\nimport * as firebase from \"firebase/app\";\nimport \"firebase/database\";\n\nconst config = {\n  apiKey: \"AIzaSyDp01-0TwxRjNC05CuDcpauXRyLSMv0RRw\",\n  authDomain: \"darts-yeslab.firebaseapp.com\",\n  databaseURL: \"https://darts-yeslab.firebaseio.com\",\n  projectId: \"darts-yeslab\",\n  storageBucket: \"darts-yeslab.appspot.com\",\n  messagingSenderId: \"426404952698\",\n  appId: \"1:426404952698:web:738ac9ab1342a1177419c3\",\n  measurementId: \"G-7DHLMBZXEN\"\n};\n\nif (!firebase.apps.length) {\n  firebase.initializeApp(config);\n}\n\nconst database = firebase.database();\n\nfunction db(ref: string) {\n  return database.ref(`/v1/${ref}`);\n}\n\nfunction createUser(userID): Promise<User> {\n  const user = {\n    created_at: Date.now()\n  };\n\n  return new Promise((resolve, reject) => {\n    console.log(\"??\");\n    db(\"users/\" + userID).set(user, error => {\n      if (error) {\n        reject(error);\n      }\n\n      resolve({ ...user, id: userID });\n    });\n  });\n}\n\nexport function getUser(userID: string): Promise<User> {\n  return db(`users/${userID}`)\n    .once(\"value\")\n    .then(function(snapshot) {\n      const user = snapshot.val();\n      if (user) {\n        return { ...user, id: userID };\n      }\n\n      return createUser(userID);\n    });\n}\n\nexport function getGame(\n  gameID: string,\n  userID: string,\n  onUpdate: any\n): Promise<Game> {\n  return new Promise((resolve, reject) => {\n    db(`/games/${gameID}`).on(\"value\", snapshot => {\n      const game = snapshot.val();\n      onUpdate(game);\n    });\n  });\n}\n\nexport function getGameId(join_id: string): Promise<string> {\n  return new Promise((resolve, reject) => {\n    db(\"games\")\n      .orderByChild(\"join_id\")\n      .equalTo(join_id)\n      .on(\"value\", function(snapshot) {\n        snapshot.forEach(function(data) {\n          const id = data.key;\n          if (!id) {\n            reject(\"Game not found.\");\n          } else {\n            resolve(id);\n          }\n        });\n      });\n  });\n}\n\nexport function createGame(userID, name): Promise<Game> {\n  const gameID = uuidv4();\n\n  const game = {\n    creator_id: userID,\n    join_id: gameID.slice(0, 4),\n    players: [\n      {\n        id: userID,\n        name\n      }\n    ]\n  };\n\n  return new Promise((resolve, reject) => {\n    db(`games/${gameID}`).set(game, error => {\n      if (error) {\n        reject(error);\n      } else {\n        resolve({ ...game, id: gameID });\n      }\n    });\n  });\n}\n\nexport function addPlayerToGame(gameID, userID, name) {\n  return new Promise((resolve, reject) => {\n    db(`games/${gameID}`)\n      .once(\"value\")\n      .then(snapshot => {\n        const game = snapshot.val();\n\n        if (!game.players.some(player => player.id === userID)) {\n          const newGame = {\n            ...game,\n            players: game.players.concat({\n              id: userID,\n              name,\n              score: DEFAULT_SCORE\n            })\n          };\n\n          db(\"games/\" + gameID).update(newGame, error => {\n            if (error) {\n              console.error(\"error\", error);\n            }\n          });\n        }\n      });\n  });\n}\n\nexport function updateScore(gameID, userID, number) {\n  return new Promise((resolve, reject) => {\n    db(`games/${gameID}`)\n      .once(\"value\")\n      .then(snapshot => {\n        const game = snapshot.val();\n\n        const newGame = { ...game };\n        newGame.players =\n          newGame.players.length > 2\n            ? handleThreePlayerGame(userID, newGame.players, number)\n            : handleTwoPlayerGame(userID, newGame.players, number);\n\n        db(\"games/\" + gameID).set(newGame, error => {\n          if (error) {\n            console.error(\"error\", error);\n          }\n        });\n      });\n  });\n}\n\nexport function resetScore(gameID, userID) {\n  return new Promise((resolve, reject) => {\n    db(`games/${gameID}`)\n      .once(\"value\")\n      .then(snapshot => {\n        const game = snapshot.val();\n\n        const newGame = { ...game };\n        newGame.players = newGame.players.map(player => {\n          if (player.id !== userID) {\n            return player;\n          }\n\n          return { ...player, score: DEFAULT_SCORE };\n        });\n\n        db(\"games/\" + gameID).set(newGame, error => {\n          if (error) {\n            console.error(\"error\", error);\n          }\n        });\n      });\n  });\n}\n\nexport function newGame(gameID) {\n  return new Promise((resolve, reject) => {\n    db(\"games/\" + gameID)\n      .once(\"value\")\n      .then(snapshot => {\n        const game = snapshot.val();\n\n        const newGame = { ...game };\n        newGame.players = newGame.players.map(player => {\n          return { ...player, score: DEFAULT_SCORE };\n        });\n\n        db(\"games/\" + gameID).set(newGame, error => {\n          if (error) {\n            console.error(\"error\", error);\n          }\n        });\n      });\n  });\n}\n\nfunction handleTwoPlayerGame(\n  userID: string,\n  originalPlayers: Array<Player>,\n  number: string | number\n) {\n  let newPlayers = originalPlayers.slice();\n\n  newPlayers = newPlayers.map(player => {\n    if (player.id !== userID) {\n      return player;\n    }\n\n    const newPlayer = { ...player };\n    const scoreForNumber = newPlayer.score[number];\n    if (scoreForNumber === 3) {\n      // Update other scores\n      newPlayer.score.total += typeof number === \"string\" ? 25 : number;\n    } else {\n      newPlayer.score[number] = scoreForNumber + 1;\n    }\n\n    return { ...newPlayer };\n  });\n\n  return newPlayers;\n}\n\nfunction handleThreePlayerGame(\n  userID: string,\n  originalPlayers: Array<Player>,\n  number: string | number\n) {\n  let newPlayers = originalPlayers.slice();\n  const amAddingToOtherPlayers = newPlayers.some(player => {\n    if (player.id === userID && player.score[number] === 3) {\n      return true;\n    }\n  });\n\n  if (amAddingToOtherPlayers) {\n    newPlayers = newPlayers.map(player => {\n      const newPlayer = { ...player };\n      if (newPlayer.score[number] !== 3 && newPlayer.id !== userID) {\n        newPlayer.score.total += typeof number === \"string\" ? 25 : number;\n      }\n      return { ...newPlayer };\n    });\n  } else {\n    newPlayers = newPlayers.map(player => {\n      if (player.id !== userID) {\n        return player;\n      }\n\n      const newPlayer = { ...player };\n      const scoreForNumber = newPlayer.score[number];\n      newPlayer.score[number] = scoreForNumber + 1;\n\n      return { ...newPlayer };\n    });\n  }\n\n  return newPlayers;\n}\n"]},"metadata":{},"sourceType":"module"}